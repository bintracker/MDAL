MDAL_VERSION(0)
USE_PATTERNS

WORD_DIRECTIVE("dw");
BYTE_DIRECTIVE("db");
HEX_PREFIX("#");


CFG_COMMANDS{
	WORD("A", 0, USE_LAST_SET|USE_RESTS(0));
	BOOL("SIDA", false, USE_LAST_SET|FORCE_SUBSTITUTION("off"=false, "on"=true));
	BOOL("NOISE", false, USE_LAST_SET|FORCE_SUBSTITUTION("off"=false, "on"=true));
	BYTE("DMODA", 0, USE_LAST_SET);
	BYTE("DUTYA", $80, USE_LAST_SET);
	WORD("B1", 0, USE_LAST_SET|USE_RESTS(0));
	WORD("B2", 0, USE_LAST_SET|USE_RESTS(0));
	WORD("PHB", 0, USE_LAST_SET);
	BYTE("MIXB", $ac, FORCE_REPEAT|FORCE_SUBSTITUTION("xor"=$ac, "and"=$a4, "or"=$b4, "none"=0));
	BYTE("DMODB1", 0, USE_LAST_SET);
	BYTE("DUTYB1", $80, USE_LAST_SET);
	BYTE("DMODB2", 0, USE_LAST_SET);
	BYTE("DUTYB2", $80, USE_LAST_SET);
	BYTE("SPD", $10, FORCE_REPEAT);
	BYTE("GSPD", $10, GLOBAL_CONST);
	BYTE("DRUM", 0, FORCE_SUBSTITUTION("kick"=1, "hhat"=$80));
}


CFG_SEQUENCE {
	USE_END("dw 0");
	USE_LOOP(LABEL, "loop");
	USE_TRACKS(1);
}

CFG_BLOCK {
	ID("Patterns");
	TYPE(PATTERN);
	USE_END("db #40");
	INIT_DEFAULTS;
	
	WORD(REQUIRED(), SET_HI(SPD), SET_LO(DRUM));
	WORD(REQUIRED(), SET_IF(!(A&DMODA&DUTYA&NOISE), 1), SET_IF(!(B1&B2&PHB&DMODB1&DMODB2&DUTYB1&DUTYB2), $40), SET_HI(MIXB), SET_BITS(SIDA, 4), SET_BITS(NOISE, $80))
	WORD(REQUIRED(A), SET_HI(DMODA), SET_LO(DUTYA));
	WORD(REQUIRED(DMODA|DUTYA), SET(A));
	WORD(REQUIRED(B1|B2|DUTYB1|DUTYB2|PHB), SET_HI(DMODB1), SET_LO(DMODB2));
	WORD(REQUIRED(B1|B2|DMODB1|DMODB2|PHB), SET_HI(DUTYB1), SET_LO(DUTYB2));
	WORD(REQUIRED(DUTYB1|DUTYB2|DMODB1|DMODB2|PHB|B2), SET(B1));
	WORD(REQUIRED(DUTYB1|DUTYB2|DMODB1|DMODB2|PHB|B1), SET(B2));
	WORD(REQUIRED(DUTYB1|DUTYB2|DMODB1|DMODB2|B1|B2), SET(PHB));
	
	REQUIRE_SET_BEGIN();
	REQUIRE_BLK_BEGIN(B1&B2&PHB&MIXB&DMODB1&DMODB2&DUTYB1&DUTYB2);

}

CFG_PATTERNS {
	USE_END("db #40");
	INIT_DEFAULTS;
	
	WORD(REQUIRED(), SET_HI(SPD), SET_LO(DRUM));
	WORD(REQUIRED(), SET_IF(!(A&DMODA&DUTYA&NOISE), 1), SET_IF(!(B1&B2&PHB&DMODB1&DMODB2&DUTYB1&DUTYB2), $40), SET_HI(MIXB), SET_BITS(SIDA, 4), SET_BITS(NOISE, $80))
	WORD(REQUIRED(A), SET_HI(DMODA), SET_LO(DUTYA));
	WORD(REQUIRED(DMODA|DUTYA), SET(A));
	WORD(REQUIRED(B1|B2|DUTYB1|DUTYB2|PHB), SET_HI(DMODB1), SET_LO(DMODB2));
	WORD(REQUIRED(B1|B2|DMODB1|DMODB2|PHB), SET_HI(DUTYB1), SET_LO(DUTYB2));
	WORD(REQUIRED(DUTYB1|DUTYB2|DMODB1|DMODB2|PHB|B2), SET(B1));
	WORD(REQUIRED(DUTYB1|DUTYB2|DMODB1|DMODB2|PHB|B1), SET(B2));
	WORD(REQUIRED(DUTYB1|DUTYB2|DMODB1|DMODB2|B1|B2), SET(PHB));
	
	REQUIRE_SET_BEGIN();
	REQUIRE_BLK_BEGIN(B1&B2&PHB&MIXB&DMODB1&DMODB2&DUTYB1&DUTYB2);
}

