MDAL_VERSION(0);
TARGET_PLATFORM("zxspectrum48");

WORD_DIRECTIVE("dw");
BYTE_DIRECTIVE("db");


CFG_COMMANDS{

	BYTE("GSPD", $10, GLOBAL_CONST);
	BYTE("SPD", SUBSTITUTE_FROM(GSPD), FORCE_REPEAT);
	WORD("A", 0, USE_LAST_SET|USE_NOTE_NAMES|ALLOW_MODIFIERS|USE_RESTS(0));
	WORD("PHA", 0, USE_LAST_SET);
	BOOL("DMOD1", false, USE_LAST_SET|FORCE_SUBSTITUTION("off"=false, "on"=true));
	BYTE("PSCA1", 0, USE_LAST_SET|FORCE_SUBSTITUTION("down"=$0f, "up"=$07, "none"=0));
	BYTE("PSCA2", 0, USE_LAST_SET|FORCE_SUBSTITUTION("down"=$0f, "up"=$07, "none"=0));
	BOOL("NOISE", false, USE_LAST_SET|FORCE_SUBSTITUTION("off"=false, "on"=true));
	BYTE("MIXA", $ac, USE_LAST_SET|FORCE_SUBSTITUTION("xor"=$ac, "and"=$a4, "or"=$b4, "none"=$b7));
	WORD("B", 0, USE_LAST_SET|USE_NOTE_NAMES|ALLOW_MODIFIERS|USE_RESTS(0));
	WORD("PHB", 0, USE_LAST_SET);
	BYTE("DMOD2", 0, USE_LAST_SET);
	BYTE("PSCB1", 0, USE_LAST_SET|FORCE_SUBSTITUTION("down"=$0f, "up"=$07, "none"=0));
	BYTE("PSCB2", 0, USE_LAST_SET|FORCE_SUBSTITUTION("down"=$0f, "up"=$07, "none"=0));
	BYTE("MIXB", $ac, USE_LAST_SET|FORCE_SUBSTITUTION("xor"=$ac, "and"=$a4, "or"=$b4, "none"=0));
	WORD("C", 0, USE_LAST_SET|USE_NOTE_NAMES|ALLOW_MODIFIERS|USE_RESTS(0));
	BYTE("PSCC", 0, USE_LAST_SET|FORCE_SUBSTITUTION("down"=$0f, "up"=$07, "none"=0));
	BOOL("SLDIR", false, USE_LAST_SET|FORCE_SUBSTITUTION("down"=false, "up"=true));
	BYTE("SLSPD", 0, USE_LAST_SET);		
}


CFG_SEQUENCE {
	USE_END("dw 0");
	USE_LOOP(LABEL, "mloop");
	USE_TRACKS(1);
}

CFG_BLOCK {
	ID("Patterns");
	TYPE(PATTERN);
	USE_END("db $40");
	INIT_DEFAULTS;
	
	WORD(REQUIRED(), SET_HI(SPD), SET_IF(!(A&PHA&DMOD1&PSCA1&PSCA2&MIXA&NOISE), 1), SET_IF(!(B&PHB&MIXB&PSCB1&PSCB2&DMOD2), 4), SET_IF(!(C&SLDIR&SLSPD&PSCC), $80));
	WORD(REQUIRED(A|PHA|DMOD1|PSCA1|PSCA2|MIXA|NOISE), SET_HI(PSCA1), SET_IF(PHA, 1), SET_BITS(DMOD1, $40), SET_BITS(NOISE, $cb00));
	WORD(SET(PHA));
	WORD(REQUIRED(A|PHA|DMOD1|PSCA1), SET_HI(MIXA), SET_LO(PSCA2), SET_BITS(NOISE, $2));
	WORD(REQUIRED(PHA|DMOD1|PSCA1|PSCA2|MIXA|NOISE), SET(A));
	WORD(REQUIRED(B|PHB|PSCB1|PSCB2|DMOD2), SET_HI(MIXB), SET_IF(PHB, 1), SET_IF(DMOD2, $40));
	WORD(SET(PHB));
	WORD(SET_HI(DMOD2));
	WORD(REQUIRED(B|PHB|MIXB|DMOD2), SET_LO(PSCB1), SET_HI(PSCB2));
	WORD(REQUIRED(PHB|PSCB1|PSCB2|MIXB|DMOD2), SET(B));
	WORD(REQUIRED(C), SET_HI(PSCC), SET_LO(SLSPD));
	WORD(REQUIRED(PSCC|SLSPD), SET(C), SET_BITS(SLDIR, $8000));

	REQUIRE_SEQ_BEGIN();

}
